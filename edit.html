<!DOCTYPE html>
<html>
	<head>
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script type="text/javascript">
		var appFiles = "https://script.google.com/macros/s/AKfycby8FMMIJQkm0lAqUzyP_epJiw1dP3JMZ8VdiTGHckpfEVpecs-N/exec";
		var appBlogs = "https://script.google.com/macros/s/AKfycbwlmoiBY_Ip2lt5QICMmOhOnX_dCrAo4_YMsOLk3hmx5M-kihAT/exec";
		var ListAllBlog = "https://script.google.com/macros/s/AKfycbyKzP6PVt8N7Z0lWbxzUk-DS2z2wtz4xRZGKpRRkOKLmsLWiUPK/exec";
		var appFolders = "https://script.google.com/macros/s/AKfycbyH1kJBvD1jZ4HaHNUnZm-nQKvDkH_RLv_8JNbd9aL5Rxh3FBg/exec";
		var currFileID;
		var currFolderID;
		$(document).ready(function(e) {
					$('#diagram').hide()
					currFileID = window.location.search.split("?")[1].split('&')[0].split("=")[1];
					currFolderID = window.location.search.split("?")[1].split('&')[1].split("=")[1];

					$('#folder_selection select').val(currFolderID);
					console.log(currFileID);
					$.get(appBlogs,

							{
									FileID:currFileID,
									"command":"read"
							},
						function (data) {
							//console.log("the result is :"+data);
							console.log(data);
							title = data.split('$$')[0];

							content = data.split('$$')[1];
							$('#is_draft_id').val(data.split('$$')[2]);
							$('#is_public_id').val(data.split('$$')[3]);

							/*
							var mode = content.pop();
							if(mode=="777"){
								$('#is_publicInput').attr('checked', true);
							}else if (mode == "000"){
								$('#is_publicInput').attr('checked', false);
							}
							content.shift();

							$('#text-input').val(content.join());
							*/
							$('#text-input').val(content);
							$('#text-input')[0].editor.update()
							$('#titleInput').val(title);
						});
					document.getElementById('text-input').focus();

		});



    </script>
		<script src="markdown.js"></script>
	<script src = "html_preprocessing.js"></script>
	<script src="js/raphael.min.js"></script>
	<script src="js/flowchart.min.js"></script>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script type="text/javascript">
				function Delete(){
					console.log(currFileID);
					$.get(appFiles, {

								"command":"commandDeleteFile",
								"FileID":currFileID
							},
							function (data) {
								$(location).attr('href', 'admin.html');
					});

				}
        function SendScore(){
					var currFileID = window.location.search.split("?")[1].split('&')[0].split("=")[1];
					console.log(currFileID);
					var mode;
					if($("#is_publicInput").prop("checked")){
						mode = "777"
					}else{
						mode = "000"
					}
				$.post(appFiles, {

						  "command":"blog_update",
						  "FileID":currFileID,
						  "FolderID": parseInt($('#folder_selection select').val()),
						  "filename":  document.getElementById("titleInput").value,
						  "content":document.getElementById("text-input").value,
							"is_public":parseInt($('#is_public_id').val()),
							"is_draft":parseInt($('#is_draft_id').val())
						},
						function (data) {
				});
        }
    </script>
	</head>
  <body>
<div class="container">
<div class="row">

	<div class="col-lg-12 bg-info">
		<div id="div_photo_list"></div>
	</div>
	<div class="col-lg-12" id="preview_link" style="overflow:auto"></div>

	<div class="col-lg-12 bg-info">
    		title: <input type="text" id="titleInput"><br><br>
	</div>
	<div class="col-lg-12 bg-info" id="folder_selection">
		<select>
			<option value=4>recipe</option>
			<option value=2>computer_science</option>
			<option value=3>woodwork</option>
			<option value=22>teaching_plan</option>
			<option value=21>uxdata.tw</option>
		</select>
	</div>
		<div class="col-lg-12 bg-info">
		<select id="is_public_id">
				   <option value=0>Private</option>
					 <option value=1>Public</option>

		</select>
		<select id="is_draft_id">
		       <option value=0>Publish</option>
		       <option value=1>Draft</option>
		</select>
	</div>
	<div class="col-lg-6" id="title">
	    <textarea class="AutoHeight" id="text-input" oninput=this.editor.update()
               style="width:100%" rows="30">Type **Markdown** here.test
	  </textarea>
	</div>
    	<div class="col-lg-6" id="preview"> </div>
	<div class="col-lg-12">
    		<input type="button" value="Update" onclick="SendScore()">
				<input type="button" value="Delete" onclick="Delete()">

	</div>

<div id="diagram"></div>
	</div>
</div>




    <script>
      var filename;
      //var socket = io.connect();
      var current_dir = '';

      $(document).ready(function(){
	$('#text').focus(function(){
		$('#text').val("");
	});
	$('#text').val("input your command here\n");

        $('#text').keypress(function(e){
          //socket.emit('client_data', {
          //  'letter': String.fromCharCode(e.charCode)
          //}i);

	  if(e.charCode==13){ //enter(i.e. return)
		num_input_element = $('#text').val().split('\n').length;
//		console.log($('#text-input').val());
		var cmd;
		if(num_input_element==1){
			cmd = $('#text').val();
		}else{
			cmd = $('#text').val().split('\n')[1];

		}

		$('#text').val('');
	   }
        });
      });
    </script>

    <script src="showdown.min.js"></script>
    <script>
	var converter = new showdown.Converter();
	converter.setOption('tables',true);
	converter.setOption('tasklists',true);
      function Editor(input, preview) {
        this.update = function () {
		preview.innerHTML = "";
		content = input.value;
		//console.log(content);
		[preprocessed_content, parse_result, StringSet] = html_preprocessing(content);
		for(var i=0;i<StringSet.length;i++){
			switch(StringSet[i].property){
				case "markdown_input":{
					//console.log("markdown_input");
//					console.log(StringSet[i].data);
					var html_results = markdown.toHTML(StringSet[i].data);
					preview.innerHTML += html_results;
					break;
				}
				case "system_cmd":{
					//console.log("system_cmd");
					break;
				}
				case "html":{
					//console.log("html");
//					console.log(StringSet[i].data);
					preview.innerHTML += StringSet[i].data;

					break;
				}
				case "u2b":{
					preview.innerHTML += StringSet[i].data;
					break;
				}
				case "flowchart":{
					console.log(StringSet[i].data);
					tmp = StringSet[i].data;
					var diagram = flowchart.parse(tmp);
					$('#diagram').html('');
					diagram.drawSVG('diagram');

					preview.innerHTML += $('#diagram').html();
					break;
				}
			}
		}
		  var final_html = html_results;
		  var preview_height = $('#preview').height();
		  if(preview_height < 100) preview_height = 100;

		  $('.AutoHeight').height(preview_height);
        };
        input.editor = this;
//	$("#text-input").height($("#preview").height());
//	input.height(preview.height());
        this.update();
      }
      var $$ = function (id) { return document.getElementById(id); };
      new Editor($$("text-input"), $$("preview"));
    </script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  </body>
</html>
