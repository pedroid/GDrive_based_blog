<!DOCTYPE html>
<html>
	<head>
	    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
			<script src="https://www.gstatic.com/firebasejs/live/3.1/firebase.js"></script>

		<script type="text/javascript">
		var appFiles = "https://script.google.com/macros/s/AKfycby8FMMIJQkm0lAqUzyP_epJiw1dP3JMZ8VdiTGHckpfEVpecs-N/exec";
		var appBlogs = "https://script.google.com/macros/s/AKfycbwlmoiBY_Ip2lt5QICMmOhOnX_dCrAo4_YMsOLk3hmx5M-kihAT/exec";
		var ListAllBlog = "https://script.google.com/macros/s/AKfycbyKzP6PVt8N7Z0lWbxzUk-DS2z2wtz4xRZGKpRRkOKLmsLWiUPK/exec";
		var appFolders = "https://script.google.com/macros/s/AKfycbyH1kJBvD1jZ4HaHNUnZm-nQKvDkH_RLv_8JNbd9aL5Rxh3FBg/exec";

			var has_submitted = false;
			var uid;
			$(document).ready(function(e) {

				//firebase
							var config = {
							apiKey: "AIzaSyAtI63y6oM7PO4p0U2AEMsXrhScPYeC3GA",
							authDomain: "uxapi-74e8b.firebaseapp.com",
							databaseURL: "https://uxapi-74e8b.firebaseio.com",
							projectId: "uxapi-74e8b",
							storageBucket: "",
							messagingSenderId: "1051481601400"
							};
							firebase.initializeApp(config);

							firebase.auth().onAuthStateChanged(firebaseUser=>{
								if(firebaseUser){
										console.log('hi,'+firebaseUser.email);
										uid = firebaseUser.uid;

								}else{
										console.log('not logged in');
										window.location = "login.html";
								}
							});

				//end of firebase

				if(window.location.search!=""){
					var filename_tmp = window.location.search.split("?")[1].split('&')[0].split("=")[1];
					var FolderID = parseInt(window.location.search.split("?")[1].split('&')[1].split("=")[1]);
					$('#folder_selection select').val(FolderID);
					$('#titleInput').val(filename_tmp);
				}
			});
			$('#text-input').focus()

		</script>
		<script src="js/raphael.min.js"></script>
		<script src="js/flowchart.min.js"></script>

		<script src="markdown.js"></script>
	<script src = "html_preprocessing.js"></script>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script type="text/javascript">
	var currFileID;
        function SendScore(){
			if(!has_submitted){
				console.log('submit!');
				var mode;
				if($("#is_publicInput").prop("checked")){
					mode = "777"
				}else{
					mode = "000"
				}
				//var FolderID = window.location.search.split("?")[1].split('&')[1].split("=")[1];
				var FolderID = parseInt($('#folder_selection select').val());
				//console.log(FolderID);
				$.post(appFiles, {
						  "command":"blog_new",
							"filename": document.getElementById("titleInput").value,
							"content": document.getElementById("text-input").value,
							"FolderID": FolderID,
							"is_public":parseInt($('#is_public_id').val()),
							"is_draft":parseInt($('#is_draft_id').val()),
							"uid":uid
						},
						function (data) {
							currFileID = parseInt(data);
							//console.log(data);
							//$('#feedback').html(data)
						//    document.write("--------------------------");
						//   document.write("Result = "+data);
						//   document.write("--------------------------");
				});
				$('#submit_button').val('update')
				has_submitted = true;
			}else{
				$.post(appFiles, {

						  "command":"blog_update",
						  "FileID":currFileID,
						  "FolderID": parseInt($('#folder_selection select').val()),
						  "filename":  document.getElementById("titleInput").value,
						  "content":document.getElementById("text-input").value,
							"is_public":parseInt($('#is_public_id').val()),
							"is_draft":parseInt($('#is_draft_id').val()),
							"uid":uid
						},
						function (data) {
							//console.log(data);

							//$('#feedback').html(data)
						//    document.write("--------------------------");
						//   document.write("Result = "+data);
						//   document.write("--------------------------");
				});
			}
        }
    </script>
	</head>
  <body>
<div class="container">
<div class="row">
	<div class="col-lg-12 bg-info">
		<div id="div_photo_list"></div>
	</div>
	<div class="col-lg-12" id="preview_link" style="overflow:auto"></div>
	<div class="col-lg-12">
    		title: <input type="text" id="titleInput"><br><br>
	</div>
	<div class="col-lg-12" id="folder_selection">
		<select>
			<option value=4>recipe</option>
			<option value=2>computer_science</option>
			<option value=3>woodwork</option>
			<option value=22>teaching_plan</option>
			<option value=21>uxdata.tw</option>
			<option value=23>course</option>
		</select>
	</div>

	<div class="col-lg-12">
	<select id="is_public_id">
				 <option value=0>Private</option>
				 <option value=1>Public</option>

	</select>
	<select id="is_draft_id">
				 <option value=0>Publish</option>
				 <option value=1>Draft</option>
	</select>
</div>
	<div class="col-lg-6" id="title">
	    <textarea class="AutoHeight" id="text-input" oninput=this.editor.update()
               style="width:100%" rows="30">Type **Markdown** here.test
	  </textarea>
	</div>
    	<div class="col-lg-6" id="preview"> </div>
	<div class="col-lg-12">
    		<input id="submit_button" type="button" value="submit" onclick="SendScore()">

	</div>
<div id="diagram"></div>

	</div>
</div>




    <script>
      var filename;
      //var socket = io.connect();
      var current_dir = '';

      $(document).ready(function(){
	$('#text').focus(function(){
		$('#text').val("");
	});
	$('#text').val("input your command here\n");
/*
	socket.emit('markdown',{
		'type':'cmd',
		'command':'ls_photo',
		'path':current_dir
	});
*/
        $('#text').keypress(function(e){
          //socket.emit('client_data', {
          //  'letter': String.fromCharCode(e.charCode)
          //}i);

	  if(e.charCode==13){ //enter(i.e. return)
		num_input_element = $('#text').val().split('\n').length;
//		console.log($('#text-input').val());
		var cmd;
		if(num_input_element==1){
			cmd = $('#text').val();
		}else{
			cmd = $('#text').val().split('\n')[1];

		}
		switch(cmd.split(' ')[0]){
			case('save'):{
				console.log('save');
//				console.log($('#text-input').html());
				if(filename){
					console.log(parse_result.tag_content_array);
					//console.log($('#preview').html());
					socket.emit('markdown',{
						'type':'cmd',
						'command':'save',
						'markdown_content':$('#text-input').val(),
						'html_content':$('#preview').html(),
						'path':current_dir,
						'filename':filename,
						'publish':parse_result.publish,
						'tag':parse_result.tag_content_array
					});
					//console.log('markdown content:'+$('#text-input').val());
					console.log('file saved');
					$('#client_response').html('file saved');
				}else{
					console.log('please select a file to edit');
					$('#client_response').html('please select a file to edit');
					break;
				}
				break;
			}
			case('ls'):{
//				console.log('ls');
				console.log('ls:'+current_dir);
				socket.emit('markdown',{
					'type':'cmd',
					'command':'ls',
					'path':current_dir
				});
				break;
			}
			case('ls_photo'):{
//				console.log('ls');
				console.log('ls:'+current_dir);
				socket.emit('markdown',{
					'type':'cmd',
					'command':'ls_photo',
					'path':current_dir
				});
				break;
			}
			case('edit'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					filename = argv;
					socket.emit(
						'markdown',
						{
							'type':'cmd',
							'command':'edit',
							'filename':filename
						}
					);
					$('#title').html(current_dir+filename+'.markdown');
				}else{

					$('#client_response').html('please enter the filename as argument[1]');
				}
				break;
			}
			case('mkdir'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					socket.emit('markdown',{
						'type':'cmd',
						'command':'mkdir',
						'path':argv
					});

				}else{
					$('#client_response').html('please enter the directory name as argument[1]');

				}
				break;

			}
			case('cd'):{
				console.log('cmd:'+cmd);
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					socket.emit('markdown',{
						'type':'cmd',
						'command':'cd',
						'path':argv
					});
					$('#form_dir_name').val(argv);
				}else{

					$('#client_response').html('please enter the filepath as argument[1]');
				}
				/*
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					if(argv=='..'){
						var new_path='';
						var path_tmp = current_dir.split('/');
						switch(path_tmp.length){
							case 2: console.log('you are alrealy in root');
								break;
							case 3: path_tmp.splice(1,1);break;
							case 4: path_tmp.splice(2,1);break;
						}
						for(var i=0;i<path_tmp.length;i++){
							new_path+=path_tmp[i];
							if(path_tmp[i]=='')break;
							new_path+='/';
						}
						console.log('2:'+new_path);
						current_dir = new_path;
					}else{
						current_dir += argv+'/';
					}
					$('#title').html('/'+current_dir+filename+'.markdown');

				}else{
					$('#client_response').html('please enter the filepath as argument[1]');

				}
				*/
				break;
			}

			case('rm'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					filename = argv;
					socket.emit('markdown',{
						'type':'cmd',
						'command':'rm',
						'filename':argv
					});
				}else{
					$('#client_response').html('please enter the filename as argument[1]');

				}
				break;
			}
			case('new'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					filename = argv;
					$('#title').html(current_dir+filename+'.markdown');

				}else{
					console.log('please enter the filename as argument[1]');
					$('#client_response').html('please enter the filename as argument[1]');
				}
				break;

//				console.log('argv:'+argv);
			}
			case('clear'):{
				filename='';
				$('#title').html('[filename]');
				break;
			}

			default:{
				$('#client_response').html('command not support.');
			}
		}

		$('#text').val('');
	   }
        });
      });
    </script>

    <script src="showdown.min.js"></script>
    <script>
	var converter = new showdown.Converter();
	converter.setOption('tables',true);
	converter.setOption('tasklists',true);
      function Editor(input, preview) {
        this.update = function () {
		preview.innerHTML = "";
		content = input.value;
		//console.log(content);
		[preprocessed_content, parse_result, StringSet] = html_preprocessing(content);
		for(var i=0;i<StringSet.length;i++){
			switch(StringSet[i].property){
				case "markdown_input":{
					//console.log("markdown_input");
//					console.log(StringSet[i].data);
					var html_results = markdown.toHTML(StringSet[i].data);
					preview.innerHTML += html_results;
					break;
				}
				case "system_cmd":{
					//console.log("system_cmd");
					break;
				}
				case "html":{
					//console.log("html");
//					console.log(StringSet[i].data);
					preview.innerHTML += StringSet[i].data;

					break;
				}
				case "u2b":{
					preview.innerHTML += StringSet[i].data;
					break;
				}
				case "flowchart":{
					console.log(StringSet[i].data);
					tmp = StringSet[i].data;
					var diagram = flowchart.parse(tmp);
					$('#diagram').html('');
		  		diagram.drawSVG('diagram');

					preview.innerHTML += $('#diagram').html();
					break;
				}
			}
		}
		  var final_html = html_results;
		  var preview_height = $('#preview').height();
		  if(preview_height < 100) preview_height = 100;

		  $('.AutoHeight').height(preview_height);
        };
        input.editor = this;
//	$("#text-input").height($("#preview").height());
//	input.height(preview.height());
        this.update();
      }
      var $$ = function (id) { return document.getElementById(id); };
      new Editor($$("text-input"), $$("preview"));
    </script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  </body>
</html>
